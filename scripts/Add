function Invoke-AwsCliJson {
    param(
        [Parameter(Mandatory = $true)]
        [string[]] $Arguments,
        [string]   $Profile
    )

    $fullArgs = @('--output','json','--no-cli-pager')
    if ($Profile) { $fullArgs += @('--profile', $Profile) }
    $fullArgs += $Arguments

    # Capture only stdout; keep stderr separate so it doesn't poison JSON.
    $stdout = & aws @fullArgs 2>$null

    if ($LASTEXITCODE -ne 0) {
        # Try to retrieve stderr to show a useful error
        $stderr = & aws @fullArgs 1>$null 2>&1
        throw "AWS CLI command failed ($LASTEXITCODE): aws $($fullArgs -join ' ')`n$stderr"
    }

    # PowerShell 5.1 often returns string[]; join lines to a single JSON string
    $jsonText = ($stdout -join "`n")

    try {
        return $jsonText | ConvertFrom-Json
    }
    catch {
        throw "Unable to parse AWS CLI response as JSON: aws $($fullArgs -join ' ')`n$jsonText"
    }
}
